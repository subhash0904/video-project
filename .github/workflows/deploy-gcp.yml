name: Deploy to GCP

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  
jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/gcp_key
          chmod 600 ~/.ssh/gcp_key
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to GCP (with rollback support)
        env:
          VM_IP: ${{ secrets.GCP_VM_IP }}
          VM_USER: ${{ secrets.GCP_VM_USER }}
        run: |
          ssh -i ~/.ssh/gcp_key $VM_USER@$VM_IP << 'ENDSSH'
            set -e
            cd ~/video-project || exit 1

            # ---- snapshot current state for rollback ----
            PREV_COMMIT=$(git rev-parse HEAD)
            echo "üìå Previous commit: $PREV_COMMIT"

            cd infra
            # Tag running images so we can restore them
            for SVC in backend frontend api-gateway event-streaming realtime-service transcoder; do
              IMG=$(docker-compose -f docker-compose.production.yml images -q "$SVC" 2>/dev/null || true)
              if [ -n "$IMG" ]; then
                docker tag "$IMG" "video-platform/${SVC}:rollback" 2>/dev/null || true
              fi
            done
            cd ..

            # ---- deploy new code ----
            echo "üì• Pulling latest code..."
            git pull origin main || git pull origin master

            cd infra

            echo "üõë Stopping existing containers..."
            docker-compose -f docker-compose.production.yml down

            echo "üßπ Cleaning up dangling images..."
            docker image prune -f

            echo "üöÄ Starting services..."
            docker-compose -f docker-compose.production.yml up -d --build

            echo "‚è≥ Waiting for services to become healthy..."
            sleep 45

            # ---- health-gate ----
            HEALTHY=true
            for PORT in 80 4000 4100; do
              if ! curl -sf --max-time 10 "http://localhost:${PORT}/health" > /dev/null 2>&1; then
                echo "‚ùå Health check failed on port ${PORT}"
                HEALTHY=false
              fi
            done

            if [ "$HEALTHY" = "false" ]; then
              echo "‚ö†Ô∏è  Rolling back to previous commit ${PREV_COMMIT}..."
              docker-compose -f docker-compose.production.yml down
              cd ..
              git checkout "$PREV_COMMIT"
              cd infra
              docker-compose -f docker-compose.production.yml up -d --build
              echo "‚è≥ Waiting for rollback to stabilise..."
              sleep 30
              echo "üîô Rollback complete ‚Äî running on ${PREV_COMMIT}"
              exit 1
            fi

            echo "‚úÖ Deployment healthy!"
            docker-compose -f docker-compose.production.yml ps
            echo "‚úÖ Deployment complete!"
          ENDSSH
      
      - name: Verify deployment
        if: success()
        env:
          VM_IP: ${{ secrets.GCP_VM_IP }}
        run: |
          echo "üîç Verifying deployment..."
          sleep 10
          curl -f http://$VM_IP/health || echo "‚ö†Ô∏è API Gateway health check failed"
          curl -f http://$VM_IP:4000/health || echo "‚ö†Ô∏è Backend health check failed"
          curl -f http://$VM_IP:4100/health || echo "‚ö†Ô∏è WebSocket health check failed"
          echo "‚úÖ Verification complete"
      
      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/gcp_key

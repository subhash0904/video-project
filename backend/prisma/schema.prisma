// Prisma Schema for Video Platform
// Database: PostgreSQL
// Architecture: YouTube-correct (Users â‰  Channels)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  username        String    @unique
  passwordHash    String?   // Optional for OAuth users
  displayName     String
  avatarUrl       String?
  
  // Auth fields
  emailVerified   Boolean   @default(false)
  verificationToken String?
  resetToken      String?
  resetTokenExpiry  DateTime?
  
  // OAuth fields
  googleId        String?   @unique
  
  // Two-Factor Authentication
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?   // Encrypted TOTP secret
  backupCodes      String?   // Encrypted JSON array of backup codes
  
  // Preferences
  language        String    @default("en")
  theme           String    @default("dark")
  restrictedMode  Boolean   @default(false)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?
  
  // Relations
  channel         Channel?
  subscriptions   Subscription[]
  watchHistory    WatchHistory[]
  likes           Like[]
  comments        Comment[]
  commentLikes    CommentLike[]
  analyticsEvents AnalyticsEvent[]
  notifications   Notification[]
  shares          Share[]
  
  @@index([email])
  @@index([username])
  @@index([googleId])
  @@map("users")
}

// ============================================
// CHANNEL
// ============================================

model Channel {
  id              String   @id @default(uuid())
  userId          String   @unique
  
  // Channel info
  handle          String   @unique  // @username format
  name            String
  description     String?
  bannerUrl       String?
  avatarUrl       String?
  
  // Stats (denormalized for performance)
  subscriberCount Int      @default(0)
  videoCount      Int      @default(0)
  totalViews      BigInt   @default(0)
  
  // Verification
  verified        Boolean  @default(false)
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  videos          Video[]
  subscribers     Subscription[]
  
  @@index([handle])
  @@index([userId])
  @@map("channels")
}

// ============================================
// VIDEO
// ============================================

enum VideoStatus {
  PROCESSING
  READY
  FAILED
  DELETED
}

enum VideoType {
  STANDARD
  SHORT
  LIVE
}

enum VideoCategory {
  FILM_ANIMATION
  AUTOS_VEHICLES
  MUSIC
  PETS_ANIMALS
  SPORTS
  TRAVEL_EVENTS
  GAMING
  PEOPLE_BLOGS
  COMEDY
  ENTERTAINMENT
  NEWS_POLITICS
  HOWTO_STYLE
  EDUCATION
  SCIENCE_TECH
  NONPROFITS_ACTIVISM
  KIDS
  OTHER
}

model Video {
  id              String      @id @default(uuid())
  channelId       String
  
  // Video info
  title           String
  description     String?
  thumbnailUrl    String
  duration        Int         // seconds
  type            VideoType   @default(STANDARD)
  category        VideoCategory @default(OTHER)
  status          VideoStatus @default(PROCESSING)
  
  // Streaming
  hlsUrl          String?     // Master playlist URL
  dashUrl         String?     // Future: DASH support
  
  // Metadata
  uploadedAt      DateTime    @default(now())
  publishedAt     DateTime?
  processedAt     DateTime?
  
  // Stats removed - moved to video_stats table (event-driven counters)
  
  // Privacy & monetization
  isPublic        Boolean     @default(true)
  allowComments   Boolean     @default(true)
  ageRestricted   Boolean     @default(false)
  
  // Relations
  channel         Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  qualities       VideoQuality[]
  watchHistory    WatchHistory[]
  userLikes       Like[]
  comments        Comment[]
  analyticsEvents AnalyticsEvent[]
  
  @@index([channelId])
  @@index([status])
  @@index([type])
  stats           VideoStats?
  shares          Share[]
  
  @@index([channelId])
  @@index([status])
  @@index([type])
  @@index([category])
  @@index([publishedAt===============================
// VIDEO QUALITY VARIANTS
// ============================================

model VideoQuality {
  id          String   @id @default(uuid())
  videoId     String
  
  quality     String   // 144p, 360p, 720p, 1080p, 2160p
  resolution  String   // 256x144, 640x360, etc.
  bitrate     Int      // kbps
  fps         Int      @default(30)
  codec       String   @default("h264")
  
  fileUrl     String   // HLS playlist for this quality
  fileSize    BigInt   // bytes
  
  createdAt   DateTime @default(now())
  
  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@unique([videoId, quality])
  @@index([videoId])
  @@map("video_qualities")
}

// VIDEO STATS (EVENT-DRIVEN COUNTERS)
// ============================================

model VideoStats {
  videoId       String   @id
  
  // Aggregated counters (updated via background workers/Kafka)
  viewCount     BigInt   @default(0)
  likeCount     BigInt   @default(0)
  dislikeCount  BigInt   @default(0)
  commentCount  BigInt   @default(0)
  shareCount    BigInt   @default(0)
  
  updatedAt     DateTime @updatedAt
  
  // Relations
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@map("video_stats")
}

// ============================================
// SHARES (EVENT TABLE)
// ============================================

model Share {
  id          String   @id @default(uuid())
  userId      String?  // Nullable for anonymous shares
  videoId     String
  
  platform    String?  // facebook, twitter, whatsapp, copy_link, etc.
  createdAt   DateTime @default(now())
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@index([videoId, createdAt])
  @@index([userId])
  @@map("shares")
}

// ============================================
// ============================================
// SUBSCRIPTION
// ============================================

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  channelId       String
  
  // Notification settings
  notificationsOn Boolean  @default(true)
  
  subscribedAt    DateTime @default(now())
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel         Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
  @@map("subscriptions")
}

// ============================================
// WATCH HISTORY
// ============================================

model WatchHistory {
  id              String   @id @default(uuid())
  userId          String
  videoId         String
  
  // Watch metrics
  watchedAt       DateTime @default(now())
  watchDuration   Int      // seconds watched
  completed       Boolean  @default(false)
  lastPosition    Int      @default(0) // seconds
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@uap("watch_history")
}

// ============================================
// LIKES
// ============================================

enum LikeType {
  LIKE
  DISLIKE
}

model Like {
  commentLikes    CommentLike[]
  id        String   @id @default(uuid())
  userId    String
  videoId   String
  
  type      LikeType
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@map("likes")
}

// ============================================
// COMMENT LIKES/DISLIKES
// ============================================

model CommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  
  type      LikeType
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id              String    @id @default(uuid())
  userId          String
  videoId         String
  parentId        String?   // For replies
  
  content         String
  
  // Stats
  likes           Int       @default(0)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  edited          Boolean   @default(false)
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parent          Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  @@index([videoId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

// ============================================
// ANALYTICS EVENTS
// ============================================

enum EventType {
  VIDEO_VIEW
  VIDEO_LIKE
  VIDEO_DISLIKE
  VIDEO_SHARE
  CHANNEL_VIEW
  SEARCH
  VIDEO_QUALITY_CHANGE
  PLAYBACK_ERROR
}

model AnalyticsEvent {
  id          String    @id @default(uuid())
  userId      String?   // Nullable for anonymous events
  videoId     String?   // Nullable for non-video events
  
  eventType   EventType
  metadata    Json?     // Flexible field for event-specific data
  
  // Context
  sessionId   String?
  userAgent   String?
  ipAddress   String?
  country     String?
  device      String?
  
  timestamp   DateTime  @default(now())
  
  // Relations
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  video       Video?    @relation(fields: [videoId], references: [id], onDelete: SetNull)
  
  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([videoId, timestamp])
  @@map("analytics_events")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String    @id @default(uuid())
  userId        String
  type          String    // NEW_VIDEO, COMMENT, COMMENT_REPLY, LIKE_MILESTONE, SUBSCRIBER, VIDEO_PROCESSED, SYSTEM
  title         String
  body          String
  thumbnailUrl  String?
  actionUrl     String?
  metadata      Json?
  read          Boolean   @default(false)
  readAt        DateTime?
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, read, createdAt])
  @@index([userId, createdAt])
  @@map("notifications")
}
